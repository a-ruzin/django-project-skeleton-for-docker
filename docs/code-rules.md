# FOT-report

## Принципы:
 - начинать разработку сразу с "мяса" (моделей) и не терять время на настройку базового проекта
 - единообразно поднимать проект локально и на проде (и чтобы подобные проекты не мешались друг другу)
 - настроены линтеры для проверки типов и аккуратного кода
 - использование удачных решений с прошлых проектов
 - шаблоны для ведения документации
 - набор стандартных команд по работе с проектами


## Скелет репозитория:
	https://github.com/a-ruzin/django-project-skeleton-for-docker


## Единообразно поднимать проект локально и на проде
### Docker
- docker-compose.yml (под git)
- docker-compose.override.yml (вне репозитория)

 ![containers](c2.svg)

### Makefile
- **all** - собирает все образы и запускает проект
- **test** - запускает тесты
- **testv** - запускает тесты в verbose режиме
- **clean_db** - очищает базу
- **dump_db** - делает дамп базы
- **restore_db** - восстанавливает базу из дампа
- **build** - собирает образы
- **up** - поднимает проект
- **down** - останавливает проект
- **migrate** - применяет миграции
- **migrations** - создает миграции
- **static** - собирает статику
- **shell** - запускает шелл джанго
- **nginx** - заходит в контейнер с nginx
- **js** - собирает js

## Структура репозитория:
```
├── .env - переменные окружения (привязки к хостовой системе, не в репо)
├── .env.example.env - образец .env (в репо)
├── Makefile - команды для работы с проектом
├── docker-compose.yml - описание контейнеров
├── docker-compose.override.yml - локальные переопределения (не в репо)
├── .pre-commit-config.yaml - настройки pre-commit hook
│
├── app - джанго приложение
├── app-static - образ для nginx, раздающего статику
├── db
│   └── bin
│       ├── backup.sh - скрипт бэкапа базы
│       └── restore.sh - скрипт восстановления базы из бэкапа
├── deploy - деплой скрипты (не в репо)
│   ├── ci_scripts - скрипты CI/CD
│   ├── data - тут в основном бэкапы, но может быть что-то еще
│   ├── logs - сюда сбрасываются логи
│   └── crontab
├── docs - документация
│   ├── ADR - архитектурные решения
│   ├── API-GUIDE - описание API (не справочник) с примерами
│   ├── ARCHITECHTURE-C4 - диаграммы C4
│   ├── NOTES - копипаста обращений к ИИ
│   ├── TECHREQ - технические требования
│   ├── installation.md - инструкция по установке
│   └── localization.md - инструкция по локализации
├── nginx - конфиги nginx
└── frontend
```

## .pre-commit:
   - eof
   - black
   - isort
   - mypy
   - flake8/ruff

## Django
```
├── config - стартовое приложение
├── base - склад для базовых классов
├── core - основное приложение
├── lib - всякие вспомогательный либки, которые не имеют завязок на бизнес-логику
├── tests - тесты
│   ...
└── i.py
```

### config
Основное приложение "config"

	django-admin startproject config

 - settings/__init__.py - настройки джанго
 - CSRF:
   - по переменным из .env (PROJECT_IP, ...)
   - nginx (X-Forwarded-*)
 - settings/logging.py :: command_file (используется в base/management/commands/core_base_command.py)

### base
Приложение, где хранятся базовые классы, от которых мы наследуем все свое
 - admin/base_admin.py - (добавляются поля created_at, updated_at)
 - management/commands/core_base_command.py - базовая команда для наследования (для логирования в отдельный файл)
 - models/core_model.py - базовая модель (поля created_at, updated_at)
 - models/conditions/core_base_condition.py - базовая модель условий (условия для фильтров)
 - apps.py - тут бы default_auto_field = "django.db.models.BigAutoField" заменить на UUID
 - views.py - миксины для обертки DRF ответов (успех, ошибка, пагинация)

 - core - модели, менеджеры, миграции, базовые сериализаторы, базовые вьюсеты, базовые тесты
 - users - кастомная модель пользователя, регистрация, аутентификация, восстановление пароля
 - api - роутинг, базовые настройки API
 - common - утилиты, миксины, фильтры, пермишены, задачи

### core
Основное приложение "мясо"
```
├── admin -
├── api
│   └── v1
│       ├── serializers
│       │   ├── fotreport - папка с сериализаторами для модели FotReport
│       │   │   ├── fotreport_serializer.py - простой сериализатор
│       │   │   ├── fotreport_serializer_for_creation.py - для создания
│       │   │   ├── fotreport_serializer_with_extra_fields - для отображения доп полей
│       │   │   └── extra_fields_for_fotreport.py - доп поля для FotReport
│       │   │   ...
│       │   └── base_model_serializer.py - базовый серилизатор (добвляет поле $serializer)
│       ├── views
│       │   ├── fotreport_view_set.py - (разные сериализаторы, swagger, кастомные action'ы, разные пермиссии)
│       │   └── ...
│       └── urls.py - (регистрация моделей DRF, tokens, swagger, version, user(me))
├── choices - все перечислимые константы
├── controllers - "бизнес-логика" работы с моделями
├── dtos - модели для передачи данных (DTO), pydantic
├── lib - библиотеки связанные с бизнес-логикой нашего приложения
├── managment
├── migrations
├── models
│   ├── conditions - !!!
│   ├── managers
│   ├── querysets
│   │   ...
│   └── fot_report.py
├── permissions - кастомные пермишены для DRF
├── static
├── templates
├── templatetags
├── views
│   ├── admin - (иллюстрация группировки вьюх)
│   │   ...
│   └── index_view.py
│   ...
└── apps.py
```

### i.py

Штука типа `manage.py shellplus`, только лучше ;-)
```python
FotReport.iget(3)
FotReport.iget('Факт')
FotReport.iget(branch__name='ho', month='2025-05-01')
```

Фишки:
 - контроллеры - классы в которые вынесена бизнес-логика из моделей, большинство методов либо статические или class-методы (можно было бы делать и не классами)
   - позволяют избежать циклических импортов (хотя не всегда, т.к. некоторые контроллеры должны вызывать другие контроллеры)
   - можно выносить общую логику работы с несколькими моделями (в "толстых" моделях не всегда понятно куда положить метод, например user.subscribe_on_topic или topic.subscribe_user, в контроллерах SubscriptionController.subscribe(user, topic))
 - классы Choice'ов - могут использоваться не только в моделях, но и в библиотеках и контроллерах
 - классы Condition - предикатная логика не размазывается по всему коду, а сосредточена в одном классе
   - сделать лучше: как-то примиксовать Condition'ы к модели, чтобы и менеджер объектов подхачился и свойства у объектов появились
 - url по которому можно увидеть в браузере ветку, последний коммит и его дату/время version.json
 - тесты
   - есть правила написания тестов (docs/TECHREQ/req_0003_test_style_guide.md)
   - повторяют структуру приложения (чтобы проще было искать)
      ```
      tests
          core
              api
                  v1
                      serializers
                          fotreport
                              test_fotreport_serializer.py
                          ...
              models
              ...
              conftest.py
              factories.py
      ```
   - использование фикстур вместо фабрик напрямую (фабрики регистрируются)
 - для связи с внешними сервисами возможно использовать классы-адаптеры (на примере advmarker'а) - так, логика конвертации одних типов в другие будет сосредоточена в этому классе.
 - использование md + puml для документации


Что можно было бы сделать лучше:
 - вынести SSL за скобки из проекта


Вопросы:
 - куда совать тесты? /core/tests
                      /tests/core/...
